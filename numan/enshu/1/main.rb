def lu_decompose3x3(matA) #=> [matL, matU]
  # matA = matL * matU
  l11, l21, l31 = matA[0][0], matA[1][0], matA[2][0]
  u12, u13 = (matA[0][1] / l11), (matA[0][2] / l11)
  l22, l32 = (matA[1][1] - l21 * u12), (matA[2][1] - l31 * u12)
  u23 = (matA[1][2] - l21 * u13) / l22
  l33 = matA[2][2] - l31 * u13 - l32 * u23
  return [ [[l11, 0, 0], [l21, l22, 0], [l31, l32, l33]],
           [[1, u12, u13], [0, 1, u23], [0, 0, 1]] ]
end

def vec2s(vec)
  '[' + vec.map{|x| "%5.2f" % x }.join(',') + ']'
end

def mat2s(mat)
  '[' + mat.map{|vec| vec2s vec }.join(',') + ']'
end

R1, R3, R4, R0 = 4, 4, 5, 1 #[Ω]
E = 15 #[V]

0.step(by: 0.5, to: 10) { |r2|
  matA = [[R1+r2+R0, -R0, -r2], [-R0, R3+R4+R0, -R4], [-r2, -R4, r2+R4]]
  vecB = [0, 0, E]
  matL, matU = *lu_decompose3x3(matA)
  y1 = vecB[0] / matL[0][0]
  y2 = (vecB[1] - y1*matL[1][0]) / matL[1][1]
  y3 = (vecB[2] - y1*matL[2][0] - y2*matL[2][1]) / matL[2][2]
  i3 = y3 / matU[2][2]
  i2 = (y2 - i3*matU[1][2]) / matU[1][1]
  i1 = (y1 - i3*matU[0][2] - i2*matU[0][1]) / matU[0][0]
  puts "R2 = %4.1f [Ω] => I0 = %5.2f [A]" % [r2, i1 - i2]
  puts "  L = #{mat2s matL}"
  puts "  U = #{mat2s matU}"
  puts "  x = #{vec2s [i1, i2, i3]}"
}

=begin
$ ruby main.rb
R2 =  0.0 [Ω] => I0 = -2.50 [A]
  L = [[ 5.00, 0.00, 0.00],[-1.00, 9.80, 0.00],[-0.00,-5.00, 2.45]]
  U = [[ 1.00,-0.20,-0.00],[ 0.00, 1.00,-0.51],[ 0.00, 0.00, 1.00]]
  x = [ 0.62, 3.12, 6.12]
R2 =  0.5 [Ω] => I0 = -1.78 [A]
  L = [[ 5.50, 0.00, 0.00],[-1.00, 9.82, 0.00],[-0.50,-5.09, 2.81]]
  U = [[ 1.00,-0.18,-0.09],[ 0.00, 1.00,-0.52],[ 0.00, 0.00, 1.00]]
  x = [ 0.99, 2.76, 5.33]
R2 =  1.0 [Ω] => I0 = -1.30 [A]
  L = [[ 6.00, 0.00, 0.00],[-1.00, 9.83, 0.00],[-1.00,-5.17, 3.12]]
  U = [[ 1.00,-0.17,-0.17],[ 0.00, 1.00,-0.53],[ 0.00, 0.00, 1.00]]
  x = [ 1.22, 2.53, 4.81]
R2 =  1.5 [Ω] => I0 = -0.97 [A]
  L = [[ 6.50, 0.00, 0.00],[-1.00, 9.85, 0.00],[-1.50,-5.23, 3.38]]
  U = [[ 1.00,-0.15,-0.23],[ 0.00, 1.00,-0.53],[ 0.00, 0.00, 1.00]]
  x = [ 1.39, 2.36, 4.44]
R2 =  2.0 [Ω] => I0 = -0.73 [A]
  L = [[ 7.00, 0.00, 0.00],[-1.00, 9.86, 0.00],[-2.00,-5.29, 3.59]]
  U = [[ 1.00,-0.14,-0.29],[ 0.00, 1.00,-0.54],[ 0.00, 0.00, 1.00]]
  x = [ 1.51, 2.24, 4.17]
R2 =  2.5 [Ω] => I0 = -0.54 [A]
  L = [[ 7.50, 0.00, 0.00],[-1.00, 9.87, 0.00],[-2.50,-5.33, 3.78]]
  U = [[ 1.00,-0.13,-0.33],[ 0.00, 1.00,-0.54],[ 0.00, 0.00, 1.00]]
  x = [ 1.61, 2.14, 3.96]
R2 =  3.0 [Ω] => I0 = -0.38 [A]
  L = [[ 8.00, 0.00, 0.00],[-1.00, 9.88, 0.00],[-3.00,-5.38, 3.95]]
  U = [[ 1.00,-0.12,-0.38],[ 0.00, 1.00,-0.54],[ 0.00, 0.00, 1.00]]
  x = [ 1.68, 2.07, 3.80]
R2 =  3.5 [Ω] => I0 = -0.26 [A]
  L = [[ 8.50, 0.00, 0.00],[-1.00, 9.88, 0.00],[-3.50,-5.41, 4.10]]
  U = [[ 1.00,-0.12,-0.41],[ 0.00, 1.00,-0.55],[ 0.00, 0.00, 1.00]]
  x = [ 1.74, 2.01, 3.66]
R2 =  4.0 [Ω] => I0 = -0.16 [A]
  L = [[ 9.00, 0.00, 0.00],[-1.00, 9.89, 0.00],[-4.00,-5.44, 4.22]]
  U = [[ 1.00,-0.11,-0.44],[ 0.00, 1.00,-0.55],[ 0.00, 0.00, 1.00]]
  x = [ 1.80, 1.95, 3.55]
R2 =  4.5 [Ω] => I0 = -0.07 [A]
  L = [[ 9.50, 0.00, 0.00],[-1.00, 9.89, 0.00],[-4.50,-5.47, 4.34]]
  U = [[ 1.00,-0.11,-0.47],[ 0.00, 1.00,-0.55],[ 0.00, 0.00, 1.00]]
  x = [ 1.84, 1.91, 3.46]
R2 =  5.0 [Ω] => I0 =  0.00 [A]
  L = [[10.00, 0.00, 0.00],[-1.00, 9.90, 0.00],[-5.00,-5.50, 4.44]]
  U = [[ 1.00,-0.10,-0.50],[ 0.00, 1.00,-0.56],[ 0.00, 0.00, 1.00]]
  x = [ 1.88, 1.88, 3.38]
R2 =  5.5 [Ω] => I0 =  0.06 [A]
  L = [[10.50, 0.00, 0.00],[-1.00, 9.90, 0.00],[-5.50,-5.52, 4.54]]
  U = [[ 1.00,-0.10,-0.52],[ 0.00, 1.00,-0.56],[ 0.00, 0.00, 1.00]]
  x = [ 1.91, 1.84, 3.31]
R2 =  6.0 [Ω] => I0 =  0.12 [A]
  L = [[11.00, 0.00, 0.00],[-1.00, 9.91, 0.00],[-6.00,-5.55, 4.62]]
  U = [[ 1.00,-0.09,-0.55],[ 0.00, 1.00,-0.56],[ 0.00, 0.00, 1.00]]
  x = [ 1.93, 1.82, 3.24]
R2 =  6.5 [Ω] => I0 =  0.17 [A]
  L = [[11.50, 0.00, 0.00],[-1.00, 9.91, 0.00],[-6.50,-5.57, 4.70]]
  U = [[ 1.00,-0.09,-0.57],[ 0.00, 1.00,-0.56],[ 0.00, 0.00, 1.00]]
  x = [ 1.96, 1.79, 3.19]
R2 =  7.0 [Ω] => I0 =  0.21 [A]
  L = [[12.00, 0.00, 0.00],[-1.00, 9.92, 0.00],[-7.00,-5.58, 4.77]]
  U = [[ 1.00,-0.08,-0.58],[ 0.00, 1.00,-0.56],[ 0.00, 0.00, 1.00]]
  x = [ 1.98, 1.77, 3.14]
R2 =  7.5 [Ω] => I0 =  0.25 [A]
  L = [[12.50, 0.00, 0.00],[-1.00, 9.92, 0.00],[-7.50,-5.60, 4.84]]
  U = [[ 1.00,-0.08,-0.60],[ 0.00, 1.00,-0.56],[ 0.00, 0.00, 1.00]]
  x = [ 2.00, 1.75, 3.10]
R2 =  8.0 [Ω] => I0 =  0.28 [A]
  L = [[13.00, 0.00, 0.00],[-1.00, 9.92, 0.00],[-8.00,-5.62, 4.90]]
  U = [[ 1.00,-0.08,-0.62],[ 0.00, 1.00,-0.57],[ 0.00, 0.00, 1.00]]
  x = [ 2.02, 1.73, 3.06]
R2 =  8.5 [Ω] => I0 =  0.32 [A]
  L = [[13.50, 0.00, 0.00],[-1.00, 9.93, 0.00],[-8.50,-5.63, 4.96]]
  U = [[ 1.00,-0.07,-0.63],[ 0.00, 1.00,-0.57],[ 0.00, 0.00, 1.00]]
  x = [ 2.03, 1.72, 3.03]
R2 =  9.0 [Ω] => I0 =  0.34 [A]
  L = [[14.00, 0.00, 0.00],[-1.00, 9.93, 0.00],[-9.00,-5.64, 5.01]]
  U = [[ 1.00,-0.07,-0.64],[ 0.00, 1.00,-0.57],[ 0.00, 0.00, 1.00]]
  x = [ 2.05, 1.70, 3.00]
R2 =  9.5 [Ω] => I0 =  0.37 [A]
  L = [[14.50, 0.00, 0.00],[-1.00, 9.93, 0.00],[-9.50,-5.66, 5.06]]
  U = [[ 1.00,-0.07,-0.66],[ 0.00, 1.00,-0.57],[ 0.00, 0.00, 1.00]]
  x = [ 2.06, 1.69, 2.97]
R2 = 10.0 [Ω] => I0 =  0.39 [A]
  L = [[15.00, 0.00, 0.00],[-1.00, 9.93, 0.00],[-10.00,-5.67, 5.10]]
  U = [[ 1.00,-0.07,-0.67],[ 0.00, 1.00,-0.57],[ 0.00, 0.00, 1.00]]
  x = [ 2.07, 1.68, 2.94]
=end
