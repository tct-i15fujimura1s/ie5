# ネットワークアーキテクチャ 11/6

* ネットワーク・アドレス
  * ホスト部のビットが全部 0 のアドレス
  * 192.168.6.0/24 とか
  * そのセグメント全体を示すのに用いる。
* ブロードキャストアドレス
  * ホスト部のビットが全部 1 のアドレス
  * 192.168.6.255/24 とか
  * そのセグメント全体に、IPデータグラムを送るのに用いる

## ホストからのIPデータグラムの送出
### 経路表
| destination | gateway |
| ----------- | ------- |
| 192.168.4.0/24 | 192.168.6.253 |
| 192.168.4.0/23 | 192.168.6.254 |
| 192.168.6.0/24 | 直接 |
| 0.0.0.0/0 | 192.168.6.252 (デフォルトゲートウェイ) |


* 192.168.4.0/22
  * 192.168.4.0/23
    * 192.168.4.0/24
    * 192.168.5.0/24
  * 192.168.6.0/23
    * 192.168.6.0/24
    * 192.168.7.0/24

### 次のホストへ中継 (next hop)
* IP層の話
  * 途中でEthernet層はいくつか通過するかもしれない
* 最も長くマッチしたネットワークへ送る
  * つまり、該当するネットワークが複数あれば、一番小さいものに送る
  * 効率？
    * 徳山にいる人に手紙を中継するとき、徳山の郵便局と山口県の郵便局のどちらかに送れるなら、徳山の郵便局に送る
* 同じ長さなら、回線が太い方へ送る
  * 10Gと1Gなら10G

* 192.168.4.1 なら
  * 該当:
    * 192.168.4.0/24
    * 192.168.4.0/23
    * 0.0.0.0/0
  * 192.168.4.0/24 (24ビット) が最長マッチ
  * → gateway 192.168.6.253 へ送る
* 192.168.5.2 なら
  * 該当:
    * 192.168.4.0/23
    * 0.0.0.0/0
  * 192.168.4.0/23 (23ビット) が最長マッチ
  * → gateway 192.168.6.254 へ送る
* 172.217.161.228 なら
  * 該当:
    * 0.0.0.0/0
  * 0.0.0.0/0 (0ビット) が最長マッチ
  * → gateway 192.168.6.252 へ送る


### 考えるべきこと
* この経路表ならどう動作するか？
* このネットワークならどう経路表を設定するべきか？

### 好ましくない経路表
* IPデータグラムが無限に (TTLが尽きるまで) 「ピンポン」する
* ルータ1とルータ2の間で行ったり来たり
* 回線がピンポン玉なデータグラムで埋め尽くされてそのうち使用不能に

#### ルータ1 (192.168.6.254)
| destination | gateway |
| ----------- | ------- |
| 192.168.4.0/24 | 直接 |
| 192.168.6.0/24 | 直接 |
| 0.0.0.0/0 | 192.168.6.253 |


* 0.0.0.0/0 にだけマッチするのがきたら ルータ2 に中継

#### ルータ2 (192.168.6.253)
| destination | gateway |
| ----------- | ------- |
| 192.168.4.0/24 | 直接 |
| 192.168.6.0/24 | 直接 |
| 0.0.0.0/0 | 192.168.6.254 |


* 0.0.0.0/0 にだけマッチするのがきたら ルータ1 に中継

## ネットワークを構築する手順
1. アドレスの割り振り
2. 経路表の作成
3. チェック

### アドレスの割り振り
1. ネットワークアドレス
  * 重複しないように
2. ホストアドレス
  * ルータへのアドレス付与を忘れずに

### 経路表の作成
