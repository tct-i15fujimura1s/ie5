# ネットワークアーキテクチャ 11/13
## ネットワークの構築
### ネットマスク
| ネットマスク | 説明 |
| ---------- | --- |
| `/20` | 4094台 |
| `/21` | 2046台 |
| `/22` | 1022台 |
| `/23` | 510台 |
| `/24` | 254台 |
| `/25` | 126台 |
| `/26` | 62台 |
| `/27` | 30台 |
| `/28` | 14台 |
| `/29` | 6台 |
| `/30` | 2台 |
| `/31` | 通常ありえない |
| `/32` | ホストそのもの |

#### /30
* `.0/30`: ネットワークアドレス
* `.3/30`: ブロードキャストアドレス
* `.1/30`, `.2/30` が使えるホストアドレス

#### /31
* ネットワークアドレスとブロードキャストアドレスしかないはず
  * ホスト0台
* RFC3021 Using 31-Bit Prefixes on IPv4 Point-to-Point Links
  * IPアドレス節約のため、限られた場合において/31を利用できるようになった
  * ポイントtoポイント接続のリンクのため、ネットワークアドレスもブロードキャストアドレスも必要ない

#### 需要の予測
何台のホストをつなぐか？

* `/24`を使う→254台接続する予定という意味
* 20台しかつながない・・・`/27`
  * もう20台つなぎたくなったら、再設計しないといけない
  * この場合はサブネットマスクの変更?
  * 隣がすでに使われていたらホストアドレスの再割当ても必要
  * 労力：サブネットマスクの変更＜ホストアドレスの再割当て

#### 先を見越した設計
* 最大台数を見通して
* 予備の組込み：254台を超える見通しがあるときは、`/23`を割り振って、その中の一部を使う
  * 足りないよりは余るほうがまし
  * 足りない場合
    * ネットワークをいろいろ変えないといけない
    * 隣がつめつめだった場合、隣も変えないといけない
    * 全部つめつめだったら全部変えないといけない
* 経路の集約：地理的・組織的・政治的？に近い組織を近くの空間に割当てる
  * ネットワークを統合する可能性があるときは近いアドレスにする
  * 近いアドレス→サブネットマスクの変更ぐらい
  * 遠いアドレス→ホストアドレスの再割当てが必要

#### ルータのホストアドレスを忘れてはいけない
* `/30`で2台のホストをつなぐ・・・ルータとPCで終わり
  * もう1台のPCはつなげない

### 経路の集約
* 複数のネットワークへの経路を集約できる
* ルータはときに膨大な経路表を格納する必要がある
  * メモリを節約したい


* {`.0.0/24`, `.1.0/24`} -- R1 -- `.2.0/24` -- R2 -- `.3.0/24`

#### R2の経路表
| destination | gateway | interface |
| ----------- | ------- | --------- |
| `.0.0/24` | R1 | 〇〇 |
| `.1.0/24` | R1 | 〇〇 |
| `.2.0/24` | 直接 | 〇〇 |
| `.3.0/24` | 直接 | ×× |

##### 集約後
| destination | gateway | interface |
| ----------- | ------- | --------- |
| `.0.0/23` | R1 | 〇〇 |
| `.2.0/24` | 直接 | 〇〇 |
| `.3.0/24` | 直接 | ×× |

* interfaceが違うので、`.2.0/24`と`.3.0/24`は集約できない

#### R4の経路表
| destination | gateway | interface |
| ----------- | ------- | --------- |
| `.0.0/24` | R1 | ×× |
| `.1.0/24` | R3 | 〇〇 |
| `.2.0/24` | R3 | 〇〇 |
| `.3.0/24` | 直接 | △△ |

* `.0.0/23`では入らない
* `.0.0/22`では`.0.0/24`と`.3.0/24`を含んでしまう
  * ルータのアルゴリズムを考えるとできる

##### 集約後
| destination | gateway | interface |
| ----------- | ------- | --------- |
| `.0.0/24` | R1 | ×× |
| `.0.0/22` | R3 | 〇〇 |
| `.3.0/24` | 直接 | △△ |

* `.0.1`に中継したい
  * `.0.0/24`と`.0.0/22`がマッチ
  * 小さいネットワークを優先
  * → `.0.0/24`のエントリを選ぶ

### 経路を定義する
* このようにしたい
  * PC A -> R1 -> R2 -> R3 -> PC B
  * PC B -> R3 -> R4 -> R1 -> PC A


* R1 -> R2
* R2 -> R3
* R3 -> R4
* R4 -> R1


となるようにR1~R4の経路表を設定する
